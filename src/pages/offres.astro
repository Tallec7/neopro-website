---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Button from '@/components/Button.astro';
import ClubCarousel from '@/components/ClubCarousel.tsx';
import TestimonialCarousel from '@/components/TestimonialCarousel.tsx';
import ContactForm from '@/components/ContactForm.tsx';
import { Image } from 'astro:assets';

// ── Images locales ────────────────────────────────────────────────
import heroImg from '@/assets/images/hero-offres.webp';

// ── Logos clubs (fallback) ────────────────────────────────────────
import logoRacc from '@/assets/images/logo-racc.webp';
import logoNarh from '@/assets/images/logo-narh.webp';
import logoNlf from '@/assets/images/logo-nlf-fond-blanc.webp';
import logoCorsaires from '@/assets/images/logo-corsaires.webp';
import logoRinkHockey from '@/assets/images/logo-rink-hockey.webp';

// ── Sanity (optionnel) ────────────────────────────────────────────
import { sanityClient } from '@/lib/sanity';
import {
  pricingPlansQuery,
  videoPackagesQuery,
  testimonialsQuery,
  clubLogosQuery,
} from '@/lib/queries';

// ── Types ─────────────────────────────────────────────────────────
interface PricingPlan {
  name: string;
  slug: string;
  priceAnnual: string;
  priceMonthly: string;
  popular: boolean;
  buttonVariant: 'green' | 'yellow' | 'pink' | 'black';
  features: string[];
}

interface VideoPackage {
  name: string;
  price: string | null;
  priceExtra: string | null;
  description: string;
  popular: boolean;
  features: string[];
}

interface Testimonial {
  quote: string;
  clubName: string;
}

// ── Fetch données ─────────────────────────────────────────────────
let plans: PricingPlan[] = [];
let videoPackages: VideoPackage[] = [];
let testimonials: Testimonial[] = [];
let clubs: { name: string; logoUrl: string }[] = [];

try {
  if (sanityClient) {
    const [p, v, t, c] = await Promise.all([
      sanityClient.fetch(pricingPlansQuery),
      sanityClient.fetch(videoPackagesQuery),
      sanityClient.fetch(testimonialsQuery),
      sanityClient.fetch(clubLogosQuery),
    ]);
    if (p?.length) plans = p;
    if (v?.length) videoPackages = v;
    if (t?.length) testimonials = t.map((item: any) => ({ quote: item.quote, clubName: item.clubName }));
    if (c?.length) {
      const withLogos = c.filter((item: any) => item.logoUrl);
      if (withLogos.length) {
        clubs = withLogos.map((item: any) => ({ name: item.name, logoUrl: item.logoUrl }));
      }
    }
  }
} catch {
  // Sanity non configuré
}

// ── Fallback data ─────────────────────────────────────────────────
if (!plans.length) {
  plans = [
    {
      name: 'Standard',
      slug: 'standard',
      priceAnnual: '1500',
      priceMonthly: '190',
      popular: false,
      buttonVariant: 'yellow',
      features: [
        'Mise à jour de vidéos',
        'Support 72h',
        '1 seule boucle par défaut',
        'Sponsors illimités',
        'Rotation aléatoire des partenaires',
        'Rapport de diffusion basique',
      ],
    },
    {
      name: 'Autonomie',
      slug: 'autonomie',
      priceAnnual: '2100',
      priceMonthly: '250',
      popular: true,
      buttonVariant: 'green',
      features: [
        'Accès admin club (pour ajouter des visuels/vidéos de votre côté)',
        'Mise à jour de vidéos',
        'Support 48h',
        '2 boucles par défaut (ex : break / match)',
        'Sponsors illimités',
        'Rotation aléatoire des partenaires',
        'Rapport de diffusion basique',
      ],
    },
    {
      name: 'Premium',
      slug: 'premium',
      priceAnnual: '3000',
      priceMonthly: '350',
      popular: false,
      buttonVariant: 'pink',
      features: [
        'Accès admin club',
        'Mise à jour de vidéos',
        'Support 24h',
        'Nombre de boucles par défaut illimité',
        'Intégration score',
        'Sponsors illimités',
        'Rotation contrôlée des partenaires',
        'Rapport de diffusion premium',
      ],
    },
  ];
}

if (!videoPackages.length) {
  videoPackages = [
    {
      name: 'Classique',
      price: null,
      priceExtra: null,
      description: 'Inclus par défaut dans toutes les offres',
      popular: false,
      features: [
        'Vidéo Boucle partenaires',
        'Vidéo Message partenaire premium',
        'Vidéo Annonce message club',
        'Vidéo Annonce fait de jeu',
      ],
    },
    {
      name: 'Sans shooting',
      price: '500',
      priceExtra: '250',
      description: "On intègre vos photos à nos templates d'annonce de joueurs.",
      popular: true,
      features: [
        'Package Classique',
        'Vidéos Annonce de joueurs (avec photo uniquement)',
      ],
    },
    {
      name: 'Avec shooting',
      price: '1 000',
      priceExtra: '500',
      description: 'On shoote vos joueurs et on les intègre à nos templates.',
      popular: false,
      features: [
        'Package Classique',
        'Vidéos Annonce de joueurs (avec vidéo et photo)',
        "1 shooting vidéo et photo d'1h par équipe",
        'Toutes les photos et vidéos disponibles en HD à dispo',
      ],
    },
  ];
}

if (!testimonials.length) {
  testimonials = [
    { quote: "Le jour où on a utilisé Neopro pour la première fois, ça en a surpris plus d'un.", clubName: 'RACC Handball Nantes (NM3)' },
    { quote: "Tous les joueurs attendaient que ça : voir leurs célébrations.", clubName: 'NANTES ATLANTIQUE RINK HOCKEY (D2)' },
    { quote: "C'est vraiment instantané, c'est très satisfaisant.", clubName: 'CORSAIRES DE NANTES (D1)' },
    { quote: "C'est un outil qui nous facilite la vie, ça complète vraiment le speaker.", clubName: 'NANTES LOIRE FEMININ (NF3)' },
  ];
}

if (!clubs.length) {
  clubs = [
    { name: 'RACC Handball Nantes', logoUrl: logoRacc.src },
    { name: 'NARH', logoUrl: logoNarh.src },
    { name: 'Nantes Loire Feminin', logoUrl: logoNlf.src },
    { name: 'Corsaires de Nantes', logoUrl: logoCorsaires.src },
    { name: 'Nantes Rink Hockey', logoUrl: logoRinkHockey.src },
  ];
}

// ── Helpers ──────────────────────────────────────────────────────
const borderColorMap: Record<string, string> = {
  yellow: 'border-[#fdbe00]',
  green: 'border-[#51b28b]',
  pink: 'border-[#fe6aa6]',
  black: 'border-gray-200',
};

// ── SEO ───────────────────────────────────────────────────────────
const title = 'Les offres';
const description =
  'Découvrez les offres Neopro : Standard, Autonomie, Premium. Des solutions de régie digitale finançables par vos partenaires.';
---

<BaseLayout title={title} description={description}>
  <!-- Hero -->
  <section class="relative h-[743px] overflow-hidden">
    <Image
      src={heroImg}
      alt="Les offres Neopro"
      class="absolute inset-0 w-full h-full object-cover"
      loading="eager"
      widths={[640, 1024, 1440, 1920]}
      sizes="100vw"
    />
    <div class="absolute inset-0 bg-[rgba(47,57,53,0.6)]"></div>
    <div class="relative z-10 h-full flex flex-col justify-end px-[20px] md:px-[40px] lg:px-[60px] pb-[60px] md:pb-[80px]">
      <p class="text-[16px] tracking-[2px] text-[#d9d9d9] uppercase mb-[20px]">LES OFFRES</p>
      <h1 class="text-[36px] md:text-[50px] lg:text-[70px] leading-[1.1] text-white mb-[30px]">
        <span class="font-playfair italic">Adaptées à</span><br />
        <span class="font-black">vos besoins</span>
      </h1>
      <div>
        <Button href="#contact" variant="green" arrow>Obtenez un devis</Button>
      </div>
    </div>
  </section>

  <!-- 3 offres -->
  <section class="px-[20px] md:px-[40px] lg:px-[60px] py-[60px] md:py-[96px]">
    <div class="max-w-[1320px] mx-auto">
      <h2 class="text-[28px] md:text-[36px] lg:text-[48px] font-bold text-[#101828] mb-[60px]">3 offres disponibles</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-[20px]">
        {plans.map((offre) => (
          <div
            class={`relative bg-white rounded-[20px] p-[30px] flex flex-col border-4 ${borderColorMap[offre.buttonVariant] || 'border-gray-200'}`}
          >
            {offre.popular && (
              <span class="absolute -top-4 left-1/2 -translate-x-1/2 bg-[#81e3bc] text-[#2f3935] text-[18px] font-bold px-5 py-1 rounded-[40px] whitespace-nowrap">
                Le plus avantageux
              </span>
            )}
            <div class="flex items-center justify-between gap-[20px] mb-[20px]">
              <h3 class="text-[28px] font-bold">{offre.name}</h3>
              <div class="text-right shrink-0">
                <p class="text-[20px] font-bold">{offre.priceAnnual}€ TTC/an</p>
                <p class="text-[14px] text-neo-gray">(ou {offre.priceMonthly}€ TTC/mois*)</p>
              </div>
            </div>
            <ul class="list-disc pl-5 flex flex-col gap-[10px] mb-[30px] flex-1">
              {offre.features.map((f) => (
                <li class="text-[16px] text-[rgba(0,0,0,0.8)]">{f}</li>
              ))}
            </ul>
            <Button href={`/devis?offre=${offre.slug}`} variant={offre.buttonVariant} arrow>
              Choisir cette offre
            </Button>
          </div>
        ))}
      </div>
      <p class="text-center text-[18px] text-neo-gray mt-[30px]">
        *Engagement de 9 mois minimum
      </p>
    </div>
  </section>

  <!-- Package videos en option -->
  <section class="px-[20px] md:px-[40px] lg:px-[60px] py-[60px] md:py-[96px]">
    <div class="max-w-[1320px] mx-auto">
      <div class="mb-[60px]">
        <h2 class="text-[16px] tracking-[2px] text-[#101828] uppercase font-bold mb-[20px]">PACKAGE VIDÉOS EN OPTION</h2>
        <p class="text-[18px] text-neo-gray max-w-[700px]">Nous vous proposons en option de produire les vidéos d'annonce de joueurs.</p>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-[20px]">
        {videoPackages.map((pkg) => (
          <div class={`relative rounded-[20px] p-[30px] flex flex-col gap-5 ${
            pkg.price ? 'bg-white border-4 border-[#1ec5e0]' : 'bg-[rgba(217,217,217,0.6)]'
          }`}>
            {pkg.popular && (
              <span class="absolute -top-4 left-1/2 -translate-x-1/2 bg-[#79e8fa] text-[#2f3935] text-[18px] font-bold px-5 py-1 rounded-[40px] whitespace-nowrap">
                Le plus apprécié
              </span>
            )}
            <div class="flex items-center justify-between gap-[20px]">
              <h3 class="text-[22px] font-bold">{pkg.name}</h3>
              {pkg.price ? (
                <div class="text-right shrink-0">
                  <p class="text-neo-green font-bold text-[18px]">
                    {pkg.price}€ TTC/équipe
                  </p>
                  {pkg.priceExtra && (
                    <p class="text-[13px] text-neo-gray mt-1">
                      ({pkg.priceExtra}€ TTC/extra équipe)
                    </p>
                  )}
                </div>
              ) : (
                <p class="text-neo-green font-bold text-[16px]">Inclus</p>
              )}
            </div>
            <p class="text-neo-gray text-[15px]">{pkg.description}</p>
            <div>
              <p class="text-[14px] font-medium text-neo-dark mb-3">Inclus :</p>
              <ul class="list-disc pl-5 flex flex-col gap-[10px] flex-1">
                {pkg.features.map((f) => (
                  <li class="text-[14px] text-[rgba(0,0,0,0.8)]">{f}</li>
                ))}
              </ul>
            </div>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Finance par vos partenaires -->
  <section class="px-[20px] md:px-[40px] lg:px-[60px] py-[60px] md:py-[96px]">
    <div class="max-w-[1320px] mx-auto">
      <div class="bg-[rgba(129,227,188,0.4)] rounded-[20px] px-[20px] md:px-[40px] lg:px-[60px] py-[40px] md:py-[74px] flex flex-col md:flex-row items-center gap-[30px] justify-between">
        <div class="flex-1">
          <h2 class="text-[28px] md:text-[36px] lg:text-[48px] font-bold text-[#101828] mb-[20px]">
            Financé par vos partenaires
          </h2>
          <p class="text-[18px] text-[#4a5565]">
            Notre solution a pour but d'être financée par vos partenaires.<br />
            Pour cela, nous vous avons préparé un document explicatif prêt à leur être partagé.
          </p>
        </div>
        <div class="shrink-0">
          <Button variant="black">
            Télécharger le document
          </Button>
        </div>
      </div>
    </div>
  </section>

  <!-- Club Carousel -->
  <section class="px-[20px] md:px-[40px] lg:px-[60px] py-[60px] md:py-[96px]">
    <div class="max-w-[1320px] mx-auto">
      <h2 class="text-[28px] md:text-[36px] lg:text-[48px] font-bold text-[#101828]">
        Les clubs <span class="font-playfair italic text-neo-green">Neopro</span>
      </h2>
    </div>
    <div class="mt-[60px]">
      <ClubCarousel clubs={clubs} client:visible />
    </div>
  </section>

  <!-- Temoignages -->
  <TestimonialCarousel testimonials={testimonials} client:visible />

  <!-- Contact -->
  <div id="contact">
    <ContactForm client:visible />
  </div>
</BaseLayout>
