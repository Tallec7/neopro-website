---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Hero from '@/components/Hero.astro';
import Button from '@/components/Button.astro';
import SectionHeading from '@/components/SectionHeading.astro';
import ClubCarousel from '@/components/ClubCarousel.tsx';
import TestimonialCarousel from '@/components/TestimonialCarousel.tsx';
import ContactForm from '@/components/ContactForm.tsx';

// ── Images locales ────────────────────────────────────────────────
import heroImg from '@/assets/images/hero-offres.webp';

// ── Logos clubs (fallback) ────────────────────────────────────────
import logoRacc from '@/assets/images/logo-racc.webp';
import logoNarh from '@/assets/images/logo-narh.webp';
import logoNlf from '@/assets/images/logo-nlf-fond-blanc.webp';
import logoCorsaires from '@/assets/images/logo-corsaires.webp';
import logoRinkHockey from '@/assets/images/logo-rink-hockey.webp';

// ── Sanity (optionnel) ────────────────────────────────────────────
import { sanityClient } from '@/lib/sanity';
import {
  pricingPlansQuery,
  videoPackagesQuery,
  testimonialsQuery,
  clubLogosQuery,
} from '@/lib/queries';

// ── Types ─────────────────────────────────────────────────────────
interface PricingPlan {
  name: string;
  slug: string;
  priceAnnual: string;
  priceMonthly: string;
  popular: boolean;
  buttonVariant: 'green' | 'yellow' | 'pink' | 'black';
  features: string[];
}

interface VideoPackage {
  name: string;
  price: string | null;
  priceExtra: string | null;
  description: string;
  popular: boolean;
  features: string[];
}

interface Testimonial {
  quote: string;
  clubName: string;
}

// ── Fetch données ─────────────────────────────────────────────────
let plans: PricingPlan[] = [];
let videoPackages: VideoPackage[] = [];
let testimonials: Testimonial[] = [];
let clubs: { name: string; logoUrl: string }[] = [];

try {
  if (sanityClient) {
    const [p, v, t, c] = await Promise.all([
      sanityClient.fetch(pricingPlansQuery),
      sanityClient.fetch(videoPackagesQuery),
      sanityClient.fetch(testimonialsQuery),
      sanityClient.fetch(clubLogosQuery),
    ]);
    if (p?.length) plans = p;
    if (v?.length) videoPackages = v;
    if (t?.length) testimonials = t.map((item: any) => ({ quote: item.quote, clubName: item.clubName }));
    if (c?.length) {
      // Ne garder que les clubs ayant une image uploadée dans Sanity
      const withLogos = c.filter((item: any) => item.logoUrl);
      if (withLogos.length) {
        clubs = withLogos.map((item: any) => ({ name: item.name, logoUrl: item.logoUrl }));
      }
    }
  }
} catch {
  // Sanity non configuré
}

// ── Fallback data ─────────────────────────────────────────────────
if (!plans.length) {
  plans = [
    {
      name: 'Standard',
      slug: 'standard',
      priceAnnual: '1500',
      priceMonthly: '190',
      popular: false,
      buttonVariant: 'yellow',
      features: [
        'Mise à jour de vidéos',
        'Support 72h',
        '1 seule boucle par défaut',
        '10 partenaires max (dans la boucle par défaut)',
        "Pas d'analytics",
      ],
    },
    {
      name: 'Autonomie',
      slug: 'autonomie',
      priceAnnual: '2100',
      priceMonthly: '250',
      popular: true,
      buttonVariant: 'green',
      features: [
        'Accès admin club',
        'Mise à jour de vidéos',
        'Support 48h',
        '2 boucles par défaut (ex : break / match)',
        'Sponsors illimités',
        'Analytics basique',
      ],
    },
    {
      name: 'Premium',
      slug: 'premium',
      priceAnnual: '3000',
      priceMonthly: '350',
      popular: false,
      buttonVariant: 'pink',
      features: [
        'Support 24h',
        'Nombre de boucles par défaut illimité (ex : avant-match/match/temp-mort/mi-temps/après-match)',
        'Intégration score',
        'Sponsors illimités',
        'Analytics premium',
      ],
    },
  ];
}

if (!videoPackages.length) {
  videoPackages = [
    {
      name: 'Classique',
      price: null,
      priceExtra: null,
      description: 'Inclus par défaut dans toutes les offres',
      popular: false,
      features: [
        'Vidéo Boucle partenaires',
        'Vidéo Message partenaire premium',
        'Vidéo Annonce message club',
        'Vidéo Annonce fait de jeu',
      ],
    },
    {
      name: 'Sans shooting',
      price: '500',
      priceExtra: '250',
      description: "On intègre vos photos à nos templates d'annonce de joueurs.",
      popular: true,
      features: [
        'Package Classique',
        'Vidéos Annonce de joueurs (avec photo uniquement)',
      ],
    },
    {
      name: 'Avec shooting',
      price: '1 000',
      priceExtra: '500',
      description: 'On shoote vos joueurs et on les intègre à nos templates.',
      popular: false,
      features: [
        'Package Classique',
        'Vidéos Annonce de joueurs (avec vidéo et photo)',
        "1 shooting vidéo et photo d'1h par équipe",
        'Toutes les photos et vidéos disponibles en HD à dispo',
      ],
    },
  ];
}

if (!testimonials.length) {
  testimonials = [
    { quote: "Le jour où on a utilisé Neopro pour la première fois, ça en a surpris plus d'un.", clubName: 'RACC Handball Nantes (NM3)' },
    { quote: "Tous les joueurs attendaient que ça : voir leurs célébrations.", clubName: 'NANTES ATLANTIQUE RINK HOCKEY (D2)' },
    { quote: "C'est vraiment instantané, c'est très satisfaisant.", clubName: 'CORSAIRES DE NANTES (D1)' },
    { quote: "C'est un outil qui nous facilite la vie, ça complète vraiment le speaker.", clubName: 'NANTES LOIRE FEMININ (NF3)' },
  ];
}

if (!clubs.length) {
  clubs = [
    { name: 'RACC Handball Nantes', logoUrl: logoRacc.src },
    { name: 'NARH', logoUrl: logoNarh.src },
    { name: 'Nantes Loire Feminin', logoUrl: logoNlf.src },
    { name: 'Corsaires de Nantes', logoUrl: logoCorsaires.src },
    { name: 'Nantes Rink Hockey', logoUrl: logoRinkHockey.src },
  ];
}

// ── Helpers ──────────────────────────────────────────────────────
const borderColorMap: Record<string, string> = {
  yellow: 'border-[#fdbe00]',
  green: 'border-[#51b28b]',
  pink: 'border-[#fe6aa6]',
  black: 'border-gray-200',
};

// ── SEO ───────────────────────────────────────────────────────────
const title = 'Les offres';
const description =
  'Découvrez les offres Neopro : Standard, Autonomie, Premium. Des solutions de régie digitale finançables par vos partenaires.';
---

<BaseLayout title={title} description={description}>
  <!-- Hero -->
  <Hero
    title={`Adaptées à vos <span class="font-playfair italic text-neo-green">besoins</span>`}
    subtitle="Les offres"
    imageSrc={heroImg}
    imageAlt="Les offres Neopro"
  />

  <!-- 3 offres -->
  <section class="py-24 px-5">
    <div class="max-w-[1200px] mx-auto">
      <h2 class="text-[28px] md:text-[36px] lg:text-[48px] font-bold text-[#101828] mb-16">3 offres pour s'adapter à vous</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        {plans.map((offre) => (
          <div
            class={`relative bg-white rounded-[20px] p-[30px] flex flex-col border-4 ${borderColorMap[offre.buttonVariant] || 'border-gray-200'}`}
          >
            {offre.popular && (
              <span class="absolute -top-4 left-1/2 -translate-x-1/2 bg-[#81e3bc] text-[#2f3935] text-[18px] font-bold px-5 py-1 rounded-[40px] whitespace-nowrap">
                Le plus avantageux
              </span>
            )}
            <h3 class="text-[28px] font-bold mb-2">{offre.name}</h3>
            <div class="flex items-baseline gap-1 mb-1">
              <span class="text-[40px] font-bold">{offre.priceAnnual}</span>
              <span class="text-[16px] text-neo-gray">€ TTC</span>
            </div>
            <p class="text-[14px] text-neo-gray mb-6">
              (ou {offre.priceMonthly}€ TTC/mois*)
            </p>
            <p class="text-[14px] font-medium text-neo-dark mb-3">Inclus :</p>
            <ul class="flex flex-col gap-3 mb-8 flex-1">
              {offre.features.map((f) => (
                <li class="flex items-start gap-2 text-[15px] text-neo-gray">
                  <span class="text-neo-green mt-0.5">&#10003;</span>
                  {f}
                </li>
              ))}
            </ul>
            <Button href={`/devis?offre=${offre.slug}`} variant={offre.buttonVariant} arrow>
              Obtenez un devis
            </Button>
          </div>
        ))}
      </div>
      <p class="text-center text-[13px] text-neo-gray mt-6">
        *Engagement de 9 mois minimum
      </p>
    </div>
  </section>

  <!-- Package videos en option -->
  <section class="py-24 px-5">
    <div class="max-w-[1200px] mx-auto">
      <SectionHeading
        title="Package vidéos"
        italicWord="en option"
        subtitle="Nous vous proposons en option de produire les vidéos d'annonce de joueurs."
      />
      <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mt-16">
        {videoPackages.map((pkg) => (
          <div class={`relative rounded-[20px] p-[30px] flex flex-col gap-5 ${
            pkg.price ? 'bg-white border-4 border-[#1ec5e0]' : 'bg-[rgba(217,217,217,0.6)]'
          }`}>
            {pkg.popular && (
              <span class="absolute -top-4 left-1/2 -translate-x-1/2 bg-[#79e8fa] text-[#2f3935] text-[18px] font-bold px-5 py-1 rounded-[40px] whitespace-nowrap">
                Le plus apprécié
              </span>
            )}
            <h3 class="text-[22px] font-bold">{pkg.name}</h3>
            {pkg.price ? (
              <div>
                <p class="text-neo-green font-bold text-[18px]">
                  {pkg.price}€ TTC/équipe
                </p>
                {pkg.priceExtra && (
                  <p class="text-[13px] text-neo-gray mt-1">
                    ({pkg.priceExtra}€ TTC/extra équipe)
                  </p>
                )}
              </div>
            ) : (
              <p class="text-neo-green font-bold text-[16px]">Inclus</p>
            )}
            <p class="text-neo-gray text-[15px]">{pkg.description}</p>
            <div>
              <p class="text-[14px] font-medium text-neo-dark mb-3">Inclus :</p>
              <ul class="flex flex-col gap-2 flex-1">
                {pkg.features.map((f) => (
                  <li class="flex items-start gap-2 text-[14px] text-neo-gray">
                    <span class="text-neo-green mt-0.5">&#10003;</span>
                    {f}
                  </li>
                ))}
              </ul>
            </div>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Finance par vos partenaires -->
  <section class="py-24 px-5">
    <div class="max-w-[1320px] mx-auto">
      <div class="bg-[rgba(129,227,188,0.4)] rounded-[20px] px-5 md:px-10 lg:px-[60px] py-10 md:py-[74px] flex flex-col md:flex-row items-center gap-8 justify-between">
        <div class="flex-1">
          <h2 class="text-[28px] md:text-[36px] lg:text-[48px] font-bold text-neo-dark mb-4">
            Financé par vos <span class="font-playfair italic">partenaires</span>
          </h2>
          <p class="text-[18px] text-neo-gray">
            Notre solution a pour but d'être financée par vos partenaires. Pour cela,
            nous vous avons préparé un document explicatif prêt à leur être partagé.
          </p>
        </div>
        <div class="shrink-0">
          <Button variant="black">
            Télécharger le document
          </Button>
        </div>
      </div>
    </div>
  </section>

  <!-- Club Carousel -->
  <section class="py-24 px-5">
    <div class="max-w-[1200px] mx-auto">
      <SectionHeading
        title="Les clubs"
        italicWord="Neopro"
      />
    </div>
    <div class="mt-16">
      <ClubCarousel clubs={clubs} client:visible />
    </div>
  </section>

  <!-- Temoignages -->
  <TestimonialCarousel testimonials={testimonials} client:visible />

  <!-- Contact -->
  <div id="contact">
    <ContactForm client:visible />
  </div>
</BaseLayout>
