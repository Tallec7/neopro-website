---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Button from '@/components/Button.astro';
import SportBullet from '@/components/SportBullet.astro';
import ContactForm from '@/components/ContactForm.tsx';
import { Image } from 'astro:assets';

// ── Images locales ────────────────────────────────────────────────
import heroImg from '@/assets/images/hero-solution.webp';
import dscRetouche1 from '@/assets/images/dsc-retouche-1.webp';
import dscRetouche2 from '@/assets/images/dsc-retouche-2.webp';
import apercuTelecommande2 from '@/assets/images/apercu-telecommande-2.webp';

// ── Sanity (optionnel) ────────────────────────────────────────────
import { sanityClient } from '@/lib/sanity';
import {
  solutionPanelsQuery,
  solutionFeaturesQuery,
  colorPanelsQuery,
} from '@/lib/queries';

// ── Données : panneaux sticky ─────────────────────────────────────
interface SolutionPanel {
  title: string;
  description: string;
  imageUrl?: string;
  imageAlt?: string;
}

let solutionPanels: SolutionPanel[] = [];

try {
  if (sanityClient) {
    const data = await sanityClient.fetch(solutionPanelsQuery);
    if (data?.length) solutionPanels = data;
  }
} catch {}

if (!solutionPanels.length) {
  solutionPanels = [
    {
      title: 'Valorisez vos partenaires.',
      description:
        "Toute l'année, vos partenaires bénéficieront d'un support de communication pendant vos matchs pour partager leurs actualités. Ils peuvent mettre à jour leurs actualités d'une semaine à l'autre et obtenir des rapports de diffusion.",
    },
    {
      title: 'Célébrez vos joueurs.',
      description:
        "Vos joueurs aussi ont le droit de faire comme les pros. Nous proposons de venir filmer leurs célébrations en début d'année, ainsi que tout type de contenu (vidéo/photo) relatif à votre média day.",
    },
    {
      title: 'Partagez vos actualités.',
      description:
        "Assurez-vous que vos supporters ne passent pas à côté de vos prochains matchs, les soirées du club et vos produits à vendre sur votre boutique.",
    },
  ];
}

// Images locales pour les panneaux (fallback quand Sanity n'a pas d'image)
const panelImages = [dscRetouche1, dscRetouche2, apercuTelecommande2];

// Couleurs des icônes sport pour chaque panneau coloré
const panelIconVariants = ['pink', 'yellow', 'green', 'blue'] as const;

// ── Données : features ────────────────────────────────────────────
interface Feature {
  title: string;
  description: string;
}

let features: Feature[] = [];

try {
  if (sanityClient) {
    const data = await sanityClient.fetch(solutionFeaturesQuery);
    if (data?.length) features = data;
  }
} catch {}

if (!features.length) {
  features = [
    {
      title: 'Sans connexion internet',
      description: 'Pas besoin de wifi dans votre salle.',
    },
    {
      title: 'Sans fil',
      description:
        'Commandable à distance grâce à votre téléphone qui sert de télécommande.',
    },
    {
      title: "Simple d'utilisation",
      description:
        "Interface ultra simplifiée, utilisable par n'importe quel bénévole les jours de match.",
    },
  ];
}

// ── Données : panneaux colorés ────────────────────────────────────
interface ColorPanel {
  title: string;
  features: string[];
  bgColor: string;
}

let colorPanels: ColorPanel[] = [];

try {
  if (sanityClient) {
    const data = await sanityClient.fetch(colorPanelsQuery);
    if (data?.length) colorPanels = data;
  }
} catch {}

if (!colorPanels.length) {
  colorPanels = [
    {
      title: 'Accompagnement continu',
      features: [
        'Formation initiale complète',
        'Support technique réactif',
        'Conseils pour optimiser vos contenus',
        "Assistance & mise à jour de vidéos d'une semaine à l'autre",
        "Possibilité d'autonomie complète : accès admin avec intégration visuels/vidéos",
      ],
      bgColor: 'bg-[#3d3036]',
    },
    {
      title: 'Solution clé en main',
      features: [
        'Boîtier pré-configuré livré chez vous',
        'Installation en moins de 5 minutes',
        'Application intuitive et simple',
        'Compatible avec tous les écrans HDMI',
      ],
      bgColor: 'bg-[#423e33]',
    },
    {
      title: 'Production vidéo professionnelle',
      features: [
        'Offre de média day complète (photo+vidéo)',
        'Des templates vidéo de qualité Broadcast, personnalisable aux couleurs de votre club',
      ],
      bgColor: 'bg-[#2f3935]',
    },
    {
      title: 'Les retombées pour votre club',
      features: [
        'Image professionnelle et moderne',
        'Support de communication efficace',
        'Supporters mieux informés et engagés',
        'Visibilité quantifiée pour vos partenaires',
        'Meilleure fidélisation des partenaires',
      ],
      bgColor: 'bg-[#334244]',
    },
  ];
}

// ── Helper : format panel title (Figma : italic 1er mot + black le reste) ─
const formatPanelTitle = (title: string) => {
  const spaceIdx = title.indexOf(' ');
  if (spaceIdx === -1) return `<span class="font-bold">${title}</span>`;
  const first = title.substring(0, spaceIdx);
  const rest = title.substring(spaceIdx + 1);
  return `<span class="font-playfair italic font-normal">${first}</span> <span class="font-black">${rest}</span>`;
};

// ── SEO ───────────────────────────────────────────────────────────
const title = 'La solution de régie digitale';
const description =
  'Découvrez la solution Neopro : régie digitale clé en main pour clubs amateurs. Sans wifi, sans fil, pilotable depuis un smartphone.';
---

<BaseLayout title={title} description={description}>
  <!-- Hero -->
  <section class="relative h-[743px] overflow-hidden">
    <Image
      src={heroImg}
      alt="La solution Neopro en action"
      class="absolute inset-0 w-full h-full object-cover"
      loading="eager"
      widths={[640, 1024, 1440, 1920]}
      sizes="100vw"
    />
    <div class="absolute inset-0 bg-[rgba(47,57,53,0.5)]"></div>
    <div class="relative z-10 h-full flex flex-col justify-end px-[20px] md:px-[40px] lg:px-[60px] pb-[60px] md:pb-[80px]">
      <p class="text-[16px] tracking-[2px] text-[#d9d9d9] uppercase mb-[20px]">LA SOLUTION</p>
      <h1 class="text-[36px] md:text-[50px] lg:text-[70px] leading-[1.1] text-white mb-[30px]">
        <span class="font-playfair italic">La régie digitale de</span><br />
        <span class="font-black">votre club</span>
      </h1>
      <div>
        <Button href="#contact" variant="green" arrow>Obtenez un devis</Button>
      </div>
    </div>
  </section>

  <!-- Panneaux solution sticky -->
  <section class="pb-[60px] md:pb-[100px] pt-[40px] px-[20px] md:px-[40px] lg:px-[60px]">
    <div class="max-w-[1200px] mx-auto">
      <p class="text-[16px] font-bold opacity-60 tracking-[2px] uppercase mb-[30px]">NEOPRO QU'EST-CE QUE C'EST ?</p>
      {solutionPanels.map((panel, i) => (
        <div
          class="sticky top-[120px] bg-white rounded-[20px] shadow-lg overflow-hidden mb-8"
          style={`z-index: ${10 + i}`}
        >
          <div class="flex flex-col md:flex-row gap-[60px] py-[60px] md:py-[120px] px-[30px] md:px-[60px]">
            <div class="flex-1 flex flex-col justify-center gap-[30px]">
              <h3 class="text-[28px] md:text-[36px] lg:text-[48px]" set:html={formatPanelTitle(panel.title)} />
              <p class="text-neo-gray text-[18px]">{panel.description}</p>
            </div>
            <div class="flex-1">
              {panel.imageUrl ? (
                <img
                  src={panel.imageUrl}
                  alt={panel.imageAlt || panel.title}
                  class="w-full rounded-[20px] object-cover"
                  loading="lazy"
                />
              ) : panelImages[i] ? (
                <Image
                  src={panelImages[i]}
                  alt={panel.title}
                  class="w-full rounded-[20px] object-cover"
                  loading="lazy"
                  widths={[600, 1200]}
                  sizes="(max-width: 768px) 100vw, 50vw"
                />
              ) : null}
            </div>
          </div>
        </div>
      ))}
    </div>
  </section>

  <!-- 3 colonnes features -->
  <section class="px-[20px] md:px-[40px] lg:px-[60px] pb-[60px] md:pb-[120px] pt-[60px] md:pt-[100px]">
    <div class="max-w-[1200px] mx-auto">
      <h2 class="text-[28px] md:text-[36px] lg:text-[48px] font-bold text-[#101828] mb-[60px]">Adapté à vos clubs</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-[20px]">
        {features.map((feature) => (
          <div class="bg-[rgba(217,217,217,0.6)] rounded-[20px] p-[30px]">
            <h3 class="text-[28px] font-bold mb-[10px]">{feature.title}</h3>
            <p class="text-[18px] text-[rgba(0,0,0,0.8)]">{feature.description}</p>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Panneaux couleurs sticky -->
  <section class="px-[20px] md:px-[40px] lg:px-[60px] py-[60px] md:py-[96px]">
    <div class="max-w-[1200px] mx-auto">
      <h2 class="text-[28px] md:text-[36px] lg:text-[48px] font-bold text-[#101828] mb-[60px]">Plus qu'une solution d'affichage</h2>
      <div class="flex flex-col gap-[20px]">
        {colorPanels.map((panel, i) => (
          <div
            class={`sticky top-[120px] ${panel.bgColor} text-white rounded-[20px] px-[20px] md:px-[40px] py-[60px]`}
            style={`z-index: ${10 + i}`}
          >
            <div class="flex flex-col md:flex-row gap-[30px] md:gap-[60px] items-start">
              <h3 class="text-[28px] font-bold md:w-[300px] lg:w-[400px] shrink-0">{panel.title}</h3>
              <ul class="flex flex-col gap-[20px] flex-1">
                {panel.features.map((f) => (
                  <li class="flex items-center gap-[15px] text-[20px] text-white">
                    <SportBullet variant={panelIconVariants[i] || 'green'} />
                    {f}
                  </li>
                ))}
              </ul>
            </div>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- CTA vers offres -->
  <section class="px-[20px] md:px-[40px] lg:px-[60px] py-[60px] md:py-[96px]">
    <div class="max-w-[1200px] mx-auto">
      <div class="flex flex-col lg:flex-row items-center gap-10 lg:gap-[120px]">
        <div class="flex-1 flex flex-col gap-[20px]">
          <h2 class="text-[28px] md:text-[36px] lg:text-[48px] font-bold text-[#101828]">
            Des offres adaptées à vos clubs
          </h2>
          <p class="text-[18px] text-[#4a5565]">
            Finançable par vos partenaires. Clé en main.
          </p>
          <div class="mt-[20px]">
            <Button href="/offres" variant="black" arrow>
              Découvrez les offres
            </Button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Contact -->
  <div id="contact">
    <ContactForm client:visible />
  </div>
</BaseLayout>
